---
layout: post
title: "[OpenGL] リアルタイム・影生成 - シャドウボリューム"
categories:
- blog
tags:
- Blog
- OpenGL
- Programming
status: publish
type: post
published: true
meta: {}
author:
  login: sonson
  email: yoshida.yuichi@gmail.com
  display_name: sonson
  first_name: ''
  last_name: ''
---
<p>
<h3 class="line-header">シャドウボリュームとは？ </h3>
<p>シャドウボリュームとは，一般的に光が当たらない範囲のことを言うそうです．（定義なんてあるのかなぁ）<br />
で，そのシャドウボリュームを使ってリアルタイムに影を作成することを考えます．下図を見てください．薄紫の部分がシャドウボリュームです．このボリューム内にある物体に，光源からの光は当たりません．光の回折，反射は無視します．反射を考慮する場合は，光源を反射する物体に対して対象に作成することで回避できるかも知れませんが，回折は無理です．一般的にそこまで詳細にこだわった描画は，レイトレーシングなどの方法で描画されることが主です．<br />
<center><img src="{{ site.url }}/assets//shadow_volume1.jpg" /></center><br />
<br />
<h3 class="line-header">シャドウボリュームの作成 </h3>
<p>これがもっとも非効率的な作業となります．<br />
前セクションの”簡単な影作成”では行列変換一発で床に影を作成することができましたが，今回はボリュームを作成する必要があるので，影を作成したいオブジェクトの全頂点に対して行列変換をし，それをもとにひとつずつシャドウボリュームを作らなければなりません．<br />
下図に一つのポリゴンに対するシャドウボリュームの例を示します．この青いポリゴンが影を作るポリゴンとなります．このポリゴンが光源に対してと逆の方向にシャドウボリュームは作成されます．シャドウボリュームを形成するの各頂点は，平面射影行列などを用いて算出します．このとき，シャドウボリュームは，大きめに作成しておかないと影の届かない部分ができてしまいます．これらの頂点を用いてシャドウボリュームを描画しますが，このときすべてのポリゴンの向きをそろえて描画します．<br />
<center><img src="{{ site.url }}/assets//shadow_volume3.jpg" /></center><br />
シャドウボリュームはステンシルバッファを用いて作成します．影が描画されるべき空間は，下図のようになります．まず，シャドウボリューム以外のオブジェクトをすべて描画します．シャドウボリュームの作成は，視点に対して表向きのポリゴン，上図における手前のポリゴンを描画します．このとき，書き込まれたピクセルに対してすべてステンシル値を"1"に設定し，シャドウボリュームのデプス値を書き込まないようにします．<br />
次に裏向きのポリゴンを描画します．すると，先にかいたオブジェクトのデプスバッファが効いているので，すでにオブジェクトが描画されているところには，裏向きのポリゴンは描画されないことになります．裏向きのポリゴンと表向きのポリゴンが書き込まれたところは影のできない空間となり，裏向きのポリゴンしか書き込まれないところは影のできる空間となります．<br />
<center><img src="{{ site.url }}/assets//shadow_volume2.jpg" /></center><br />
<center><img src="{{ site.url }}/assets//shadow_volume4.jpg" /></center><br />
これを用いて，表向きのポリゴンが書き込まれているところに，裏向きのポリゴンが書き込まれた場合にはステンシル値をデクリメントし，はじめて裏向きのポリゴンが書き込まれたところには，そのままにしておきます．すると，影が映るピクセルには，すべてステンシル値，"1"が書き込まれることになります．<br />
<br />
<h3 class="line-header">実際の処理の流れ </h3>
<p>サンプルでは，波打った床と壁に四面体の影が映る様を再現しています．そのアルゴリズムの流れは下のようになります．</p>
<h3 class="numeric-list">
<li>床と壁を描画する．</li>
<li>光源と四面体を描画する．</li>
<li>デプスバッファとカラーバッファにマスクをして以後書き込みを禁止する．</li>
<li>ステンシルバッファをセットする．</li>
<li>シャドウボリュームを作り出すポリゴンが光源の方を向いているかチェックする．</li>
<li>光源の位置と，四面体の各頂点からシャドウボリュームの頂点を算出する．</li>
<li>表向きのシャドウボリュームポリゴンをステンシル値"1"で書き込む．</li>
<li>裏向きのシャドウボリュームポリゴンがデプステストに合格すると，ステンシル値と"0"，でなければ，そのままにしておく．</li>
<li>デプス，カラーバッファのマスクを解除する． </li>
<li>ステンシル値が"1"のピクセル値に対して，黒を半透明で塗る．</li>
</h3>
<p>以上が処理の流れです．５については，当然光源に対して，表向きでないポリゴンは影を作りませんから，処理を軽くするためにチェックします．<br />
<br />
<h3 class="line-header">まとめ </h3>
<p>この処理方法の汚点は，頂点の計算とシャドウボリュームの作成にあります．さらにポリゴンの描画方法を表向きと裏向きに分けて描画する部分もきれいとはいいきれませんね．なんとかうまく処理すればきれいに影をつけられそうなのですが，今のところ思いつきません．<br />
うーん，なんとかしたい．<br />
<a href="http://code.google.com/p/sonson-code/source/browse/#svn/trunk/gl/shadow_volume">http://code.google.com/p/sonson-code/source/browse/#svn/trunk/gl/shadow_volume</a></p>
